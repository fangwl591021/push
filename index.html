<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Sender Ultra Pro v1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --line-green: #06C755;
            --line-blue: #748da6;
            --editor-bg: #1e1e1e;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 1.5rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }

        .liff-id-container {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 500px;
            transition: all 0.2s;
        }

        .liff-id-container:focus-within {
            border-color: var(--line-green);
            background: white;
            box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.1);
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
        }

        #json-input {
            flex: 1;
            padding: 1.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            color: #d4d4d4;
            tab-size: 4;
        }

        .preview-wrapper {
            width: 550px;
            background: #e5e7eb;
            border-left: 1px solid #d1d5db;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .device-frame {
            width: 380px;
            min-height: 680px;
            background: var(--line-blue);
            border-radius: 48px;
            border: 12px solid #111827;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .device-header {
            height: 40px;
            background: rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .device-header::after {
            content: '';
            width: 50px;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .device-screen {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        .device-screen::-webkit-scrollbar { display: none; }

        .flex-bubble-card {
            background: white;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .status-online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        .btn-send {
            background: var(--line-green);
            color: white;
            padding: 12px 32px;
            border-radius: 14px;
            font-weight: 900;
            font-size: 16px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn-send:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-send:active { transform: scale(0.98); }

        .btn-secondary {
            background: #3c3c3c;
            color: #ccc;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: #4a4a4a; color: white; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <div class="bg-[#06C755] p-2.5 rounded-2xl text-white shadow-lg">
                <i data-lucide="send-to-back"></i>
            </div>
            <div>
                <h1 class="font-black text-slate-800 m-0 text-lg flex items-center gap-2 tracking-tight">
                    Flex Sender Pro <span class="text-xs bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full">v1.4</span>
                    <span id="liff-status-indicator" class="status-dot status-offline"></span>
                </h1>
                <p id="user-status-text" class="text-[10px] text-slate-400 font-bold uppercase m-0 tracking-widest">系統未連線</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="liff-id-container">
                <i data-lucide="shield-check" class="w-5 h-5 text-slate-400"></i>
                <input type="text" id="liff-id-input" placeholder="LIFF ID (例如 200xxxxxxx-xxxxxxxx)" 
                       class="bg-transparent text-sm w-full outline-none font-mono font-bold text-slate-700">
            </div>
            <button id="btn-login-trigger" onclick="liff.login()" class="hidden text-sm font-bold text-blue-600 hover:underline">登入</button>
            <button onclick="sendFlexMessage()" class="btn-send shadow-xl shadow-emerald-200">
                <i data-lucide="send"></i> 發送好友
            </button>
        </div>
    </header>

    <main>
        <section class="editor-wrapper">
            <div class="px-6 py-3 border-b border-white/10 flex justify-between items-center bg-[#252526]">
                <div class="flex items-center gap-6">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="code-2" class="w-3.5 h-3.5"></i> JSON Input
                    </span>
                    <div class="flex items-center gap-2 bg-[#3c3c3c] rounded px-3 py-1 text-white border border-white/5">
                        <span class="text-[9px] font-bold text-slate-400">ALT TEXT</span>
                        <input type="text" id="alt-text-input" value="收到精選訊息" 
                               class="text-xs bg-transparent outline-none w-48 font-medium">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="generateShareUrl()" class="btn-secondary">
                        <i data-lucide="link" class="w-3.5 h-3.5"></i> 產生分享連結
                    </button>
                    <button onclick="formatCode()" class="btn-secondary">
                        <i data-lucide="wand-2" class="w-3.5 h-3.5"></i> 格式化
                    </button>
                </div>
            </div>
            <textarea id="json-input" spellcheck="false" placeholder="在此處貼上 Flex Message JSON..."></textarea>
        </section>

        <section class="preview-wrapper custom-scrollbar">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="smartphone" class="w-4 h-4 text-slate-400"></i>
                <span class="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em]">Live Preview</span>
            </div>
            
            <div class="device-frame">
                <div class="device-header"></div>
                <div class="device-screen" id="preview-screen-content">
                    <div id="flex-render-mount"></div>
                </div>
            </div>

            <div class="mt-8 bg-white p-4 rounded-2xl border border-slate-200 w-full max-w-[380px] shadow-sm">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">當前部署網址 (需設為 LINE Endpoint)</p>
                <code id="debug-url" class="text-[9px] text-emerald-600 block break-all font-mono bg-slate-50 p-2 rounded border border-slate-100"></code>
            </div>
        </section>
    </main>

    <div id="toast-notif" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl text-sm font-bold transform translate-y-32 opacity-0 transition-all duration-500 z-50 flex items-center gap-3">
        <i data-lucide="check" class="w-4 h-4 text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        lucide.createIcons();

        const jsonInput = document.getElementById('json-input');
        const renderMount = document.getElementById('flex-render-mount');
        const liffIdInput = document.getElementById('liff-id-input');
        const statusIndicator = document.getElementById('liff-status-indicator');
        const userStatusText = document.getElementById('user-status-text');
        const debugUrl = document.getElementById('debug-url');
        const altTextInput = document.getElementById('alt-text-input');

        let liffReady = false;

        const welcomeMessage = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "Flex Sender v1.4", "weight": "bold", "size": "xl", "color": "#111111" },
                    { "type": "text", "text": "您可以編輯左側代碼，然後點擊「產生分享連結」來傳給其他人使用。", "size": "sm", "color": "#666666", "margin": "md", "wrap": true }
                ]
            }
        };

        window.onload = () => {
            const currentBaseUrl = window.location.href.split('?')[0];
            debugUrl.innerText = currentBaseUrl;

            // 1. 檢查網址參數是否有預載 JSON
            const urlParams = new URLSearchParams(window.location.search);
            const encodedJson = urlParams.get('msg');
            const savedId = localStorage.getItem('liff_id_v1.4');
            
            if (encodedJson) {
                try {
                    jsonInput.value = decodeURIComponent(atob(encodedJson));
                } catch (e) {
                    jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
                }
            } else {
                jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
            }

            if (savedId) {
                liffIdInput.value = savedId;
                initLIFF(savedId);
            }
            
            updateLivePreview();
        };

        async function initLIFF(id) {
            try {
                await liff.init({ liffId: id });
                liffReady = true;
                syncAuthStatus();
                showToast("LIFF 連線已就緒");
            } catch (err) {
                showToast("連線失敗：請檢查 ID 與網址");
            }
        }

        function syncAuthStatus() {
            if (liff.isLoggedIn()) {
                statusIndicator.className = "status-dot status-online";
                liff.getProfile().then(p => {
                    userStatusText.innerText = `ONLINE: ${p.displayName}`;
                });
                document.getElementById('btn-login-trigger').classList.add('hidden');
            } else {
                statusIndicator.className = "status-dot status-offline";
                userStatusText.innerText = "Offline Mode";
                document.getElementById('btn-login-trigger').classList.remove('hidden');
            }
        }

        liffIdInput.addEventListener('blur', () => {
            const id = liffIdInput.value.trim();
            if (id) {
                localStorage.setItem('liff_id_v1.4', id);
                initLIFF(id);
            }
        });

        // --- 製作分享網址邏輯 ---
        function generateShareUrl() {
            const jsonStr = jsonInput.value.trim();
            try {
                JSON.parse(jsonStr); // 驗證語法
                const encoded = btoa(encodeURIComponent(jsonStr));
                const currentBaseUrl = window.location.href.split('?')[0];
                const shareUrl = `${currentBaseUrl}?msg=${encoded}`;
                
                // 複製到剪貼簿
                const el = document.createElement('textarea');
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                showToast("分享連結已產生並複製到剪貼簿！");
            } catch (e) {
                showToast("JSON 語法錯誤，無法製作連結");
            }
        }

        function updateLivePreview() {
            try {
                let data = JSON.parse(jsonInput.value.trim());
                if (data.contents) data = data.contents;
                renderMount.innerHTML = "";
                if (data.type === "carousel") {
                    const scrollBox = document.createElement('div');
                    scrollBox.style.display = "flex";
                    scrollBox.style.gap = "12px";
                    scrollBox.style.overflowX = "auto";
                    scrollBox.style.paddingBottom = "12px";
                    data.contents.forEach(b => scrollBox.appendChild(createFlexBubble(b)));
                    renderMount.appendChild(scrollBox);
                } else {
                    renderMount.appendChild(createFlexBubble(data));
                }
            } catch (e) {}
        }

        function createFlexBubble(json) {
            const bubble = document.createElement('div');
            bubble.className = "flex-bubble-card";
            bubble.style.width = json.size === "micro" ? "180px" : (json.size === "nano" ? "140px" : "280px");
            bubble.style.flexShrink = "0";
            if (json.hero) bubble.appendChild(renderFlexComp(json.hero));
            if (json.body) bubble.appendChild(renderFlexComp(json.body));
            if (json.footer) bubble.appendChild(renderFlexComp(json.footer));
            return bubble;
        }

        function renderFlexComp(comp) {
            if (!comp) return document.createElement('div');
            let el;
            switch(comp.type) {
                case 'box':
                    el = document.createElement('div');
                    el.style.display = "flex";
                    el.style.flexDirection = comp.layout === 'horizontal' ? 'row' : 'column';
                    if (comp.paddingAll) el.style.padding = "12px";
                    if (comp.backgroundColor) el.style.backgroundColor = comp.backgroundColor;
                    if (comp.spacing) el.style.gap = "8px";
                    comp.contents?.forEach(c => el.appendChild(renderFlexComp(c)));
                    break;
                case 'text':
                    el = document.createElement('div');
                    el.innerText = comp.text;
                    el.style.fontSize = comp.size === 'xl' ? '20px' : (comp.size === 'xs' ? '11px' : '14px');
                    el.style.fontWeight = comp.weight === 'bold' ? '700' : '400';
                    el.style.color = comp.color || '#333';
                    if (comp.align === 'center') el.style.textAlign = 'center';
                    if (comp.margin) el.style.marginTop = "8px";
                    if (comp.wrap) el.style.wordBreak = "break-all";
                    break;
                case 'image':
                    el = document.createElement('img');
                    el.src = comp.url;
                    el.style.width = "100%";
                    el.style.display = "block";
                    el.style.objectFit = comp.aspectMode || "cover";
                    if (comp.aspectRatio) el.style.aspectRatio = comp.aspectRatio.replace(':', '/');
                    break;
                case 'button':
                    el = document.createElement('div');
                    el.innerText = comp.action?.label || '按鈕';
                    el.style.textAlign = "center";
                    el.style.padding = "10px";
                    el.style.margin = "4px";
                    el.style.borderRadius = "10px";
                    el.style.fontSize = "13px";
                    el.style.fontWeight = "bold";
                    if (comp.style === 'primary') {
                        el.style.background = comp.color || "#06C755";
                        el.style.color = "white";
                    } else {
                        el.style.border = "1px solid #e5e7eb";
                        el.style.color = "#4b5563";
                    }
                    break;
                default:
                    el = document.createElement('div');
            }
            return el;
        }

        async function sendFlexMessage() {
            if (!liffReady) return showToast("請確認 LIFF 初始化成功");
            if (!liff.isLoggedIn()) return liff.login();
            try {
                let flex = JSON.parse(jsonInput.value.trim());
                if (flex.contents) flex = flex.contents;
                if (Array.isArray(flex)) flex = { "type": "carousel", "contents": flex };
                const res = await liff.shareTargetPicker([
                    { "type": "flex", "altText": altTextInput.value, "contents": flex }
                ]);
                if (res) showToast("訊息已成功發送！");
            } catch (err) {
                showToast("發送內容不符規範");
            }
        }

        function formatCode() {
            try {
                const obj = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(obj, null, 4);
                updateLivePreview();
            } catch (e) { showToast("代碼有誤"); }
        }

        function showToast(msg) {
            const t = document.getElementById('toast-notif');
            document.getElementById('toast-text').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        jsonInput.addEventListener('input', updateLivePreview);
    </script>
</body>
</html>
