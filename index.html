<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex Sender Ultra Pro v1.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- ÂºïÈÄ≤Â∞àÈñÄÁ∏ÆÁü≠Á∂≤ÂùÄË≥áÊñôÁî®ÁöÑÂ£ìÁ∏ÆÂ∫´ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --line-green: #06C755;
            --line-blue: #748da6;
            --editor-bg: #1e1e1e;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9; 
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 0 1.5rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 50;
        }

        .liff-id-container {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 520px;
            transition: all 0.2s;
        }

        .liff-id-container:focus-within {
            border-color: var(--line-green);
            background: white;
            box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.1);
        }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--editor-bg);
        }

        #json-input {
            flex: 1;
            padding: 1.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            resize: none;
            background: transparent;
            color: #d4d4d4;
            tab-size: 4;
        }

        .preview-wrapper {
            width: 520px;
            background: #e5e7eb;
            border-left: 1px solid #d1d5db;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .device-frame {
            width: 360px;
            min-height: 640px;
            background: var(--line-blue);
            border-radius: 40px;
            border: 10px solid #111827;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .device-header {
            height: 35px;
            background: rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .device-header::after {
            content: '';
            width: 45px;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }

        .device-screen {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
        }
        .device-screen::-webkit-scrollbar { display: none; }

        .flex-bubble-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .status-offline { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        .btn-send {
            background: var(--line-green);
            color: white;
            padding: 10px 28px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-send:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-send:active { transform: translateY(0); }

        .btn-tool {
            background: #3c3c3c;
            color: #d1d5db;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .btn-tool:hover { background: #4b5563; color: white; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <div class="bg-[#06C755] p-2 rounded-2xl text-white shadow-lg shadow-emerald-100">
                <i data-lucide="send"></i>
            </div>
            <div>
                <h1 class="font-black text-slate-800 m-0 text-lg flex items-center gap-2 tracking-tight">
                    Flex Sender Ultra <span class="text-xs bg-slate-100 text-slate-400 px-2 py-0.5 rounded-full">v1.6</span>
                    <span id="liff-status-indicator" class="status-dot status-offline"></span>
                </h1>
                <p id="user-status-text" class="text-[10px] text-slate-400 font-bold uppercase m-0 tracking-widest">OFFLINE</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="liff-id-container shadow-sm">
                <i data-lucide="shield-check" class="w-5 h-5 text-slate-400"></i>
                <input type="text" id="liff-id-input" placeholder="Ë≤ºÂÖ•ÊÇ®ÁöÑ LIFF ID" 
                       class="bg-transparent text-sm w-full outline-none font-mono font-bold text-slate-700">
            </div>
            <button id="btn-login-trigger" onclick="liff.login()" class="hidden text-sm font-bold text-blue-600 hover:underline">ÁôªÂÖ•</button>
            <button onclick="sendFlexMessage()" class="btn-send shadow-xl shadow-emerald-200">
                <i data-lucide="share-2" class="w-4 h-4"></i> Â•ΩÂèãÂàÜ‰∫´
            </button>
        </div>
    </header>

    <main>
        <!-- Á∑®ËºØÂçÄ -->
        <section class="editor-wrapper">
            <div class="px-6 py-3 border-b border-white/10 flex justify-between items-center bg-[#252526]">
                <div class="flex items-center gap-6">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="code-2" class="w-3.5 h-3.5"></i> JSON Input
                    </span>
                    <div class="flex items-center gap-2 bg-[#3c3c3c] rounded-lg px-3 py-1 text-white border border-white/5">
                        <span class="text-[9px] font-bold text-slate-400">ALT TEXT</span>
                        <input type="text" id="alt-text-input" value="Êî∂Âà∞Á≤æÈÅ∏Ë®äÊÅØ" 
                               class="text-xs bg-transparent outline-none w-48 font-medium">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="generateShareUrl()" class="btn-tool !bg-emerald-700 !text-white shadow-lg shadow-emerald-900/20">
                        <i data-lucide="link" class="w-3.5 h-3.5"></i> Áî¢ÁîüÊ•µÁü≠ÂàÜ‰∫´ÈÄ£Áµê
                    </button>
                    <button onclick="formatCode()" class="btn-tool">
                        <i data-lucide="wand-2" class="w-3 h-3"></i> Ê†ºÂºèÂåñ
                    </button>
                    <button onclick="clearAll()" class="btn-tool !text-red-400">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Ê∏ÖÁ©∫
                    </button>
                </div>
            </div>
            <textarea id="json-input" spellcheck="false" placeholder="Âú®Ê≠§ËôïË≤º‰∏ä Flex Message JSON..."></textarea>
        </section>

        <!-- È†êË¶ΩÂçÄ -->
        <section class="preview-wrapper custom-scrollbar">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="smartphone" class="w-4 h-4 text-slate-500"></i>
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">Device Live Preview</span>
            </div>
            
            <div class="device-frame">
                <div class="device-header"></div>
                <div class="device-screen">
                    <div id="flex-render-mount"></div>
                </div>
            </div>

            <div class="mt-6 bg-white p-3.5 rounded-2xl border border-slate-200 w-full max-w-[360px] shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[9px] font-black text-slate-400 uppercase flex items-center gap-1.5">
                        <i data-lucide="info" class="w-3 h-3"></i> URL Diagnostic
                    </p>
                    <span id="url-len-badge" class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">0 chars</span>
                </div>
                <code id="debug-url" class="text-[9px] text-emerald-600 block break-all font-mono bg-slate-50 p-2 rounded-lg border border-slate-100"></code>
            </div>
        </section>
    </main>

    <div id="toast-notif" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl text-sm font-bold transform translate-y-32 opacity-0 transition-all duration-500 z-50 flex items-center gap-3">
        <i data-lucide="check-circle" class="w-4 h-4 text-emerald-400"></i>
        <span id="toast-text"></span>
    </div>

    <script>
        lucide.createIcons();

        const jsonInput = document.getElementById('json-input');
        const renderMount = document.getElementById('flex-render-mount');
        const liffIdInput = document.getElementById('liff-id-input');
        const statusIndicator = document.getElementById('liff-status-indicator');
        const userStatusText = document.getElementById('user-status-text');
        const debugUrl = document.getElementById('debug-url');
        const altTextInput = document.getElementById('alt-text-input');
        const urlLenBadge = document.getElementById('url-len-badge');

        let liffReady = false;

        const welcomeMessage = {
            "type": "bubble",
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    { "type": "text", "text": "Flex Sender v1.6", "weight": "bold", "size": "xl", "color": "#111111" },
                    { "type": "text", "text": "Ê≠§ÁâàÊú¨Êé°Áî® LZ-String Â£ìÁ∏ÆÔºåÂàÜ‰∫´ÈÄ£ÁµêÈï∑Â∫¶Á∏ÆÊ∏õ 70% ‰ª•‰∏ä„ÄÇ", "size": "sm", "color": "#666666", "margin": "md", "wrap": true }
                ]
            }
        };

        window.onload = () => {
            const currentBaseUrl = window.location.href.split('?')[0];
            debugUrl.innerText = currentBaseUrl;

            const urlParams = new URLSearchParams(window.location.search);
            const compressedJson = urlParams.get('msg');
            const liffIdParam = urlParams.get('liffId');
            
            // ÂÑ™ÂÖàÂæûÁ∂≤ÂùÄÂèÉÊï∏ËºâÂÖ• JSON (‰ΩøÁî® LZ-String Ëß£Â£ì)
            if (compressedJson) {
                try {
                    // ÂòóË©¶Áî®Êñ∞Áâà LZ-String Ëß£Â£ì
                    const decompressed = LZString.decompressFromEncodedURIComponent(compressedJson);
                    if (decompressed) {
                        jsonInput.value = JSON.stringify(JSON.parse(decompressed), null, 4);
                    } else {
                        // ÂòóË©¶Áõ∏ÂÆπ v1.5 ÁöÑËàäÁâà Base64
                        const decoded = decodeURIComponent(escape(atob(compressedJson)));
                        jsonInput.value = JSON.stringify(JSON.parse(decoded), null, 4);
                    }
                } catch (e) {
                    jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
                }
            } else {
                jsonInput.value = JSON.stringify(welcomeMessage, null, 4);
            }

            if (liffIdParam) {
                liffIdInput.value = liffIdParam;
                initLIFF(liffIdParam);
            } else {
                const savedId = localStorage.getItem('liff_id_v1.6');
                if (savedId) {
                    liffIdInput.value = savedId;
                    initLIFF(savedId);
                }
            }
            updateLivePreview();
        };

        async function initLIFF(id) {
            try {
                await liff.init({ liffId: id });
                liffReady = true;
                syncAuthStatus();
                showToast("LIFF Ê∫ñÂÇôÂ∞±Á∑í");
            } catch (err) {
                liffReady = false;
                showToast("ÂàùÂßãÂåñÂ§±Êïó");
            }
        }

        function syncAuthStatus() {
            if (liff.isLoggedIn()) {
                statusIndicator.className = "status-dot status-online";
                liff.getProfile().then(p => {
                    userStatusText.innerText = `ONLINE: ${p.displayName}`;
                });
                document.getElementById('btn-login-trigger').classList.add('hidden');
            } else {
                statusIndicator.className = "status-dot status-offline";
                userStatusText.innerText = "Â∞öÊú™ÁôªÂÖ• LINE";
                document.getElementById('btn-login-trigger').classList.remove('hidden');
            }
        }

        liffIdInput.addEventListener('blur', () => {
            const id = liffIdInput.value.trim();
            if (id) {
                localStorage.setItem('liff_id_v1.6', id);
                initLIFF(id);
            }
        });

        // --- Ë£Ω‰ΩúË∂ÖÁü≠ÂàÜ‰∫´Á∂≤ÂùÄ (Êé°Áî® LZ-String Â£ìÁ∏Æ) ---
        function generateShareUrl() {
            const jsonStr = jsonInput.value.trim();
            const liffId = liffIdInput.value.trim();
            try {
                const obj = JSON.parse(jsonStr);
                const minified = JSON.stringify(obj);
                
                // ‰ΩøÁî®Â£ìÁ∏ÆÂäõÊõ¥Âº∑ÁöÑ LZ-String
                const compressed = LZString.compressToEncodedURIComponent(minified);
                
                const currentBaseUrl = window.location.href.split('?')[0];
                let shareUrl = `${currentBaseUrl}?msg=${compressed}`;
                if (liffId) shareUrl += `&liffId=${liffId}`;
                
                // Ë§áË£Ω‰∏¶ÊèêÁ§∫
                const el = document.createElement('textarea');
                el.value = shareUrl;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                showToast(`ÈÄ£ÁµêÂ∑≤Â§ßÂπÖÁ∏ÆÁü≠‰∏¶Ë§áË£ΩÔºÅ`);
            } catch (e) {
                showToast("JSON Ë™ûÊ≥ïÈåØË™§");
            }
        }

        function updateLivePreview() {
            try {
                let data = JSON.parse(jsonInput.value.trim());
                if (data.contents) data = data.contents;
                renderMount.innerHTML = "";
                if (data.type === "carousel") {
                    const scrollBox = document.createElement('div');
                    scrollBox.style.display = "flex";
                    scrollBox.style.gap = "10px";
                    scrollBox.style.overflowX = "auto";
                    scrollBox.style.paddingBottom = "10px";
                    data.contents.forEach(b => scrollBox.appendChild(createFlexBubble(b)));
                    renderMount.appendChild(scrollBox);
                } else {
                    renderMount.appendChild(createFlexBubble(data));
                }
            } catch (e) {}
        }

        function createFlexBubble(json) {
            const bubble = document.createElement('div');
            bubble.className = "flex-bubble-card";
            bubble.style.width = json.size === "micro" ? "160px" : (json.size === "nano" ? "120px" : "260px");
            bubble.style.flexShrink = "0";
            if (json.hero) bubble.appendChild(renderFlexComp(json.hero));
            if (json.body) bubble.appendChild(renderFlexComp(json.body));
            if (json.footer) bubble.appendChild(renderFlexComp(json.footer));
            return bubble;
        }

        function renderFlexComp(comp) {
            if (!comp) return document.createElement('div');
            let el;
            switch(comp.type) {
                case 'box':
                    el = document.createElement('div');
                    el.style.display = "flex";
                    el.style.flexDirection = comp.layout === 'horizontal' ? 'row' : 'column';
                    if (comp.paddingAll) el.style.padding = "10px";
                    if (comp.backgroundColor) el.style.backgroundColor = comp.backgroundColor;
                    if (comp.spacing) el.style.gap = "6px";
                    comp.contents?.forEach(c => el.appendChild(renderFlexComp(c)));
                    break;
                case 'text':
                    el = document.createElement('div');
                    el.innerText = comp.text;
                    el.style.fontSize = comp.size === 'xl' ? '18px' : (comp.size === 'xs' ? '11px' : '13px');
                    el.style.fontWeight = comp.weight === 'bold' ? '700' : '400';
                    el.style.color = comp.color || '#333';
                    if (comp.align === 'center') el.style.textAlign = 'center';
                    if (comp.margin) el.style.marginTop = "6px";
                    if (comp.wrap) el.style.wordBreak = "break-all";
                    break;
                case 'image':
                    el = document.createElement('img');
                    el.src = comp.url;
                    el.style.width = "100%";
                    el.style.display = "block";
                    el.style.objectFit = comp.aspectMode || "cover";
                    if (comp.aspectRatio) el.style.aspectRatio = comp.aspectRatio.replace(':', '/');
                    break;
                case 'button':
                    el = document.createElement('div');
                    el.innerText = comp.action?.label || 'ÊåâÈàï';
                    el.style.textAlign = "center";
                    el.style.padding = "8px";
                    el.style.margin = "3px";
                    el.style.borderRadius = "8px";
                    el.style.fontSize = "12px";
                    el.style.fontWeight = "bold";
                    if (comp.style === 'primary') {
                        el.style.background = comp.color || "#06C755";
                        el.style.color = "white";
                    } else {
                        el.style.border = "1px solid #e5e7eb";
                        el.style.color = "#4b5563";
                    }
                    break;
                default:
                    el = document.createElement('div');
            }
            return el;
        }

        async function sendFlexMessage() {
            if (!liffReady) return showToast("Ë´ãÁ¢∫Ë™ç LIFF ÂàùÂßãÂåñÊàêÂäü");
            if (!liff.isLoggedIn()) return liff.login();
            try {
                let flex = JSON.parse(jsonInput.value.trim());
                if (flex.contents) flex = flex.contents;
                if (Array.isArray(flex)) flex = { "type": "carousel", "contents": flex };
                const res = await liff.shareTargetPicker([
                    { "type": "flex", "altText": altTextInput.value, "contents": flex }
                ]);
                if (res) showToast("üéâ Ë®äÊÅØÂ∑≤ÂÇ≥ÈÄÅÔºÅ");
            } catch (err) {
                showToast("Ê†ºÂºè‰∏çÁ¨¶Ë¶èÁØÑ");
            }
        }

        function formatCode() {
            try {
                const obj = JSON.parse(jsonInput.value);
                jsonInput.value = JSON.stringify(obj, null, 4);
                updateLivePreview();
            } catch (e) { showToast("Ë™ûÊ≥ïÈåØË™§"); }
        }

        function clearAll() {
            jsonInput.value = "";
            renderMount.innerHTML = '<div class="text-center text-slate-400 text-xs mt-20 italic">Á≠âÂæÖËº∏ÂÖ•...</div>';
            showToast("Â∑≤Ê∏ÖÁ©∫");
        }

        function showToast(msg) {
            const t = document.getElementById('toast-notif');
            document.getElementById('toast-text').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        jsonInput.addEventListener('input', () => {
            updateLivePreview();
            // Êõ¥Êñ∞Èï∑Â∫¶Ë®àÊï∏
            const len = jsonInput.value.length;
            urlLenBadge.innerText = `${len} chars`;
            urlLenBadge.className = `text-[9px] px-1.5 py-0.5 rounded font-bold ${len > 2000 ? 'bg-red-100 text-red-500' : 'bg-slate-100 text-slate-500'}`;
        });
    </script>
</body>
</html>
